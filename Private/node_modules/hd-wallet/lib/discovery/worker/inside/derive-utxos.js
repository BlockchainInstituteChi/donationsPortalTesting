'use strict';

var cov_itzd237m5 = function () {
    var path = '/home/g/dev/hd-wallet/src/discovery/worker/inside/derive-utxos.js',
        hash = 'fc021b88771807765eab942bc7c3872fa240920b',
        Function = function () {}.constructor,
        global = new Function('return this')(),
        gcv = '__coverage__',
        coverageData = {
        path: '/home/g/dev/hd-wallet/src/discovery/worker/inside/derive-utxos.js',
        statementMap: {
            '0': {
                start: {
                    line: 48,
                    column: 33
                },
                end: {
                    line: 52,
                    column: 5
                }
            },
            '1': {
                start: {
                    line: 56,
                    column: 25
                },
                end: {
                    line: 61,
                    column: 5
                }
            },
            '2': {
                start: {
                    line: 64,
                    column: 18
                },
                end: {
                    line: 69,
                    column: 5
                }
            },
            '3': {
                start: {
                    line: 71,
                    column: 4
                },
                end: {
                    line: 71,
                    column: 17
                }
            },
            '4': {
                start: {
                    line: 79,
                    column: 16
                },
                end: {
                    line: 79,
                    column: 25
                }
            },
            '5': {
                start: {
                    line: 81,
                    column: 4
                },
                end: {
                    line: 83,
                    column: 7
                }
            },
            '6': {
                start: {
                    line: 82,
                    column: 8
                },
                end: {
                    line: 82,
                    column: 20
                }
            },
            '7': {
                start: {
                    line: 84,
                    column: 4
                },
                end: {
                    line: 86,
                    column: 7
                }
            },
            '8': {
                start: {
                    line: 85,
                    column: 8
                },
                end: {
                    line: 85,
                    column: 20
                }
            },
            '9': {
                start: {
                    line: 87,
                    column: 4
                },
                end: {
                    line: 89,
                    column: 7
                }
            },
            '10': {
                start: {
                    line: 88,
                    column: 8
                },
                end: {
                    line: 88,
                    column: 24
                }
            },
            '11': {
                start: {
                    line: 91,
                    column: 4
                },
                end: {
                    line: 91,
                    column: 15
                }
            },
            '12': {
                start: {
                    line: 100,
                    column: 16
                },
                end: {
                    line: 100,
                    column: 25
                }
            },
            '13': {
                start: {
                    line: 105,
                    column: 8
                },
                end: {
                    line: 105,
                    column: 44
                }
            },
            '14': {
                start: {
                    line: 109,
                    column: 8
                },
                end: {
                    line: 117,
                    column: 11
                }
            },
            '15': {
                start: {
                    line: 110,
                    column: 12
                },
                end: {
                    line: 116,
                    column: 15
                }
            },
            '16': {
                start: {
                    line: 111,
                    column: 26
                },
                end: {
                    line: 111,
                    column: 35
                }
            },
            '17': {
                start: {
                    line: 112,
                    column: 27
                },
                end: {
                    line: 112,
                    column: 42
                }
            },
            '18': {
                start: {
                    line: 113,
                    column: 16
                },
                end: {
                    line: 115,
                    column: 17
                }
            },
            '19': {
                start: {
                    line: 114,
                    column: 20
                },
                end: {
                    line: 114,
                    column: 42
                }
            },
            '20': {
                start: {
                    line: 120,
                    column: 4
                },
                end: {
                    line: 126,
                    column: 7
                }
            },
            '21': {
                start: {
                    line: 121,
                    column: 8
                },
                end: {
                    line: 125,
                    column: 11
                }
            },
            '22': {
                start: {
                    line: 122,
                    column: 12
                },
                end: {
                    line: 124,
                    column: 13
                }
            },
            '23': {
                start: {
                    line: 123,
                    column: 16
                },
                end: {
                    line: 123,
                    column: 42
                }
            },
            '24': {
                start: {
                    line: 128,
                    column: 4
                },
                end: {
                    line: 128,
                    column: 18
                }
            },
            '25': {
                start: {
                    line: 129,
                    column: 4
                },
                end: {
                    line: 129,
                    column: 20
                }
            },
            '26': {
                start: {
                    line: 131,
                    column: 4
                },
                end: {
                    line: 131,
                    column: 15
                }
            },
            '27': {
                start: {
                    line: 140,
                    column: 41
                },
                end: {
                    line: 140,
                    column: 43
                }
            },
            '28': {
                start: {
                    line: 142,
                    column: 25
                },
                end: {
                    line: 145,
                    column: 5
                }
            },
            '29': {
                start: {
                    line: 143,
                    column: 8
                },
                end: {
                    line: 144,
                    column: 43
                }
            },
            '30': {
                start: {
                    line: 147,
                    column: 23
                },
                end: {
                    line: 149,
                    column: 5
                }
            },
            '31': {
                start: {
                    line: 148,
                    column: 8
                },
                end: {
                    line: 148,
                    column: 79
                }
            },
            '32': {
                start: {
                    line: 148,
                    column: 34
                },
                end: {
                    line: 148,
                    column: 77
                }
            },
            '33': {
                start: {
                    line: 152,
                    column: 26
                },
                end: {
                    line: 155,
                    column: 6
                }
            },
            '34': {
                start: {
                    line: 153,
                    column: 19
                },
                end: {
                    line: 153,
                    column: 58
                }
            },
            '35': {
                start: {
                    line: 154,
                    column: 8
                },
                end: {
                    line: 154,
                    column: 39
                }
            },
            '36': {
                start: {
                    line: 159,
                    column: 4
                },
                end: {
                    line: 162,
                    column: 7
                }
            },
            '37': {
                start: {
                    line: 160,
                    column: 19
                },
                end: {
                    line: 160,
                    column: 58
                }
            },
            '38': {
                start: {
                    line: 161,
                    column: 8
                },
                end: {
                    line: 161,
                    column: 23
                }
            },
            '39': {
                start: {
                    line: 165,
                    column: 19
                },
                end: {
                    line: 165,
                    column: 48
                }
            },
            '40': {
                start: {
                    line: 166,
                    column: 4
                },
                end: {
                    line: 191,
                    column: 7
                }
            },
            '41': {
                start: {
                    line: 167,
                    column: 25
                },
                end: {
                    line: 167,
                    column: 39
                }
            },
            '42': {
                start: {
                    line: 168,
                    column: 20
                },
                end: {
                    line: 168,
                    column: 73
                }
            },
            '43': {
                start: {
                    line: 168,
                    column: 51
                },
                end: {
                    line: 168,
                    column: 72
                }
            },
            '44': {
                start: {
                    line: 170,
                    column: 8
                },
                end: {
                    line: 190,
                    column: 11
                }
            },
            '45': {
                start: {
                    line: 171,
                    column: 23
                },
                end: {
                    line: 171,
                    column: 41
                }
            },
            '46': {
                start: {
                    line: 172,
                    column: 28
                },
                end: {
                    line: 172,
                    column: 50
                }
            },
            '47': {
                start: {
                    line: 173,
                    column: 12
                },
                end: {
                    line: 175,
                    column: 13
                }
            },
            '48': {
                start: {
                    line: 174,
                    column: 16
                },
                end: {
                    line: 174,
                    column: 23
                }
            },
            '49': {
                start: {
                    line: 177,
                    column: 32
                },
                end: {
                    line: 177,
                    column: 54
                }
            },
            '50': {
                start: {
                    line: 178,
                    column: 36
                },
                end: {
                    line: 188,
                    column: 13
                }
            },
            '51': {
                start: {
                    line: 189,
                    column: 12
                },
                end: {
                    line: 189,
                    column: 28
                }
            },
            '52': {
                start: {
                    line: 193,
                    column: 4
                },
                end: {
                    line: 193,
                    column: 29
                }
            }
        },
        fnMap: {
            '0': {
                name: 'deriveUtxos',
                decl: {
                    start: {
                        line: 40,
                        column: 16
                    },
                    end: {
                        line: 40,
                        column: 27
                    }
                },
                loc: {
                    start: {
                        line: 45,
                        column: 2
                    },
                    end: {
                        line: 72,
                        column: 1
                    }
                },
                line: 45
            },
            '1': {
                name: 'deriveAllTransactionHashes',
                decl: {
                    start: {
                        line: 74,
                        column: 9
                    },
                    end: {
                        line: 74,
                        column: 35
                    }
                },
                loc: {
                    start: {
                        line: 78,
                        column: 15
                    },
                    end: {
                        line: 92,
                        column: 1
                    }
                },
                line: 78
            },
            '2': {
                name: '(anonymous_2)',
                decl: {
                    start: {
                        line: 81,
                        column: 30
                    },
                    end: {
                        line: 81,
                        column: 31
                    }
                },
                loc: {
                    start: {
                        line: 81,
                        column: 36
                    },
                    end: {
                        line: 83,
                        column: 5
                    }
                },
                line: 81
            },
            '3': {
                name: '(anonymous_3)',
                decl: {
                    start: {
                        line: 84,
                        column: 32
                    },
                    end: {
                        line: 84,
                        column: 33
                    }
                },
                loc: {
                    start: {
                        line: 84,
                        column: 38
                    },
                    end: {
                        line: 86,
                        column: 5
                    }
                },
                line: 84
            },
            '4': {
                name: '(anonymous_4)',
                decl: {
                    start: {
                        line: 87,
                        column: 16
                    },
                    end: {
                        line: 87,
                        column: 17
                    }
                },
                loc: {
                    start: {
                        line: 87,
                        column: 21
                    },
                    end: {
                        line: 89,
                        column: 5
                    }
                },
                line: 87
            },
            '5': {
                name: 'deriveSpentOutputs',
                decl: {
                    start: {
                        line: 94,
                        column: 9
                    },
                    end: {
                        line: 94,
                        column: 27
                    }
                },
                loc: {
                    start: {
                        line: 99,
                        column: 15
                    },
                    end: {
                        line: 132,
                        column: 1
                    }
                },
                line: 99
            },
            '6': {
                name: 'canTxBeMine',
                decl: {
                    start: {
                        line: 104,
                        column: 13
                    },
                    end: {
                        line: 104,
                        column: 24
                    }
                },
                loc: {
                    start: {
                        line: 104,
                        column: 46
                    },
                    end: {
                        line: 106,
                        column: 5
                    }
                },
                line: 104
            },
            '7': {
                name: 'saveNew',
                decl: {
                    start: {
                        line: 108,
                        column: 13
                    },
                    end: {
                        line: 108,
                        column: 20
                    }
                },
                loc: {
                    start: {
                        line: 108,
                        column: 47
                    },
                    end: {
                        line: 118,
                        column: 5
                    }
                },
                line: 108
            },
            '8': {
                name: '(anonymous_8)',
                decl: {
                    start: {
                        line: 109,
                        column: 33
                    },
                    end: {
                        line: 109,
                        column: 34
                    }
                },
                loc: {
                    start: {
                        line: 109,
                        column: 39
                    },
                    end: {
                        line: 117,
                        column: 9
                    }
                },
                line: 109
            },
            '9': {
                name: '(anonymous_9)',
                decl: {
                    start: {
                        line: 110,
                        column: 30
                    },
                    end: {
                        line: 110,
                        column: 31
                    }
                },
                loc: {
                    start: {
                        line: 110,
                        column: 55
                    },
                    end: {
                        line: 116,
                        column: 13
                    }
                },
                line: 110
            },
            '10': {
                name: '(anonymous_10)',
                decl: {
                    start: {
                        line: 120,
                        column: 16
                    },
                    end: {
                        line: 120,
                        column: 17
                    }
                },
                loc: {
                    start: {
                        line: 120,
                        column: 21
                    },
                    end: {
                        line: 126,
                        column: 5
                    }
                },
                line: 120
            },
            '11': {
                name: '(anonymous_11)',
                decl: {
                    start: {
                        line: 121,
                        column: 25
                    },
                    end: {
                        line: 121,
                        column: 26
                    }
                },
                loc: {
                    start: {
                        line: 121,
                        column: 42
                    },
                    end: {
                        line: 125,
                        column: 9
                    }
                },
                line: 121
            },
            '12': {
                name: '_deriveUtxos',
                decl: {
                    start: {
                        line: 134,
                        column: 9
                    },
                    end: {
                        line: 134,
                        column: 21
                    }
                },
                loc: {
                    start: {
                        line: 139,
                        column: 19
                    },
                    end: {
                        line: 194,
                        column: 1
                    }
                },
                line: 139
            },
            '13': {
                name: '(anonymous_13)',
                decl: {
                    start: {
                        line: 142,
                        column: 25
                    },
                    end: {
                        line: 142,
                        column: 26
                    }
                },
                loc: {
                    start: {
                        line: 142,
                        column: 38
                    },
                    end: {
                        line: 145,
                        column: 5
                    }
                },
                line: 142
            },
            '14': {
                name: '(anonymous_14)',
                decl: {
                    start: {
                        line: 147,
                        column: 23
                    },
                    end: {
                        line: 147,
                        column: 24
                    }
                },
                loc: {
                    start: {
                        line: 147,
                        column: 31
                    },
                    end: {
                        line: 149,
                        column: 5
                    }
                },
                line: 147
            },
            '15': {
                name: '(anonymous_15)',
                decl: {
                    start: {
                        line: 148,
                        column: 27
                    },
                    end: {
                        line: 148,
                        column: 28
                    }
                },
                loc: {
                    start: {
                        line: 148,
                        column: 34
                    },
                    end: {
                        line: 148,
                        column: 77
                    }
                },
                line: 148
            },
            '16': {
                name: '(anonymous_16)',
                decl: {
                    start: {
                        line: 152,
                        column: 46
                    },
                    end: {
                        line: 152,
                        column: 47
                    }
                },
                loc: {
                    start: {
                        line: 152,
                        column: 54
                    },
                    end: {
                        line: 155,
                        column: 5
                    }
                },
                line: 152
            },
            '17': {
                name: '(anonymous_17)',
                decl: {
                    start: {
                        line: 159,
                        column: 26
                    },
                    end: {
                        line: 159,
                        column: 27
                    }
                },
                loc: {
                    start: {
                        line: 159,
                        column: 34
                    },
                    end: {
                        line: 162,
                        column: 5
                    }
                },
                line: 159
            },
            '18': {
                name: '(anonymous_18)',
                decl: {
                    start: {
                        line: 166,
                        column: 19
                    },
                    end: {
                        line: 166,
                        column: 20
                    }
                },
                loc: {
                    start: {
                        line: 166,
                        column: 83
                    },
                    end: {
                        line: 191,
                        column: 5
                    }
                },
                line: 166
            },
            '19': {
                name: '(anonymous_19)',
                decl: {
                    start: {
                        line: 168,
                        column: 40
                    },
                    end: {
                        line: 168,
                        column: 41
                    }
                },
                loc: {
                    start: {
                        line: 168,
                        column: 51
                    },
                    end: {
                        line: 168,
                        column: 72
                    }
                },
                line: 168
            },
            '20': {
                name: '(anonymous_20)',
                decl: {
                    start: {
                        line: 170,
                        column: 24
                    },
                    end: {
                        line: 170,
                        column: 25
                    }
                },
                loc: {
                    start: {
                        line: 170,
                        column: 38
                    },
                    end: {
                        line: 190,
                        column: 9
                    }
                },
                line: 170
            }
        },
        branchMap: {
            '0': {
                loc: {
                    start: {
                        line: 113,
                        column: 16
                    },
                    end: {
                        line: 115,
                        column: 17
                    }
                },
                type: 'if',
                locations: [{
                    start: {
                        line: 113,
                        column: 16
                    },
                    end: {
                        line: 115,
                        column: 17
                    }
                }, {
                    start: {
                        line: 113,
                        column: 16
                    },
                    end: {
                        line: 115,
                        column: 17
                    }
                }],
                line: 113
            },
            '1': {
                loc: {
                    start: {
                        line: 122,
                        column: 12
                    },
                    end: {
                        line: 124,
                        column: 13
                    }
                },
                type: 'if',
                locations: [{
                    start: {
                        line: 122,
                        column: 12
                    },
                    end: {
                        line: 124,
                        column: 13
                    }
                }, {
                    start: {
                        line: 122,
                        column: 12
                    },
                    end: {
                        line: 124,
                        column: 13
                    }
                }],
                line: 122
            },
            '2': {
                loc: {
                    start: {
                        line: 143,
                        column: 15
                    },
                    end: {
                        line: 144,
                        column: 42
                    }
                },
                type: 'binary-expr',
                locations: [{
                    start: {
                        line: 143,
                        column: 15
                    },
                    end: {
                        line: 143,
                        column: 30
                    }
                }, {
                    start: {
                        line: 144,
                        column: 12
                    },
                    end: {
                        line: 144,
                        column: 42
                    }
                }],
                line: 143
            },
            '3': {
                loc: {
                    start: {
                        line: 173,
                        column: 12
                    },
                    end: {
                        line: 175,
                        column: 13
                    }
                },
                type: 'if',
                locations: [{
                    start: {
                        line: 173,
                        column: 12
                    },
                    end: {
                        line: 175,
                        column: 13
                    }
                }, {
                    start: {
                        line: 173,
                        column: 12
                    },
                    end: {
                        line: 175,
                        column: 13
                    }
                }],
                line: 173
            },
            '4': {
                loc: {
                    start: {
                        line: 173,
                        column: 16
                    },
                    end: {
                        line: 173,
                        column: 64
                    }
                },
                type: 'binary-expr',
                locations: [{
                    start: {
                        line: 173,
                        column: 17
                    },
                    end: {
                        line: 173,
                        column: 37
                    }
                }, {
                    start: {
                        line: 173,
                        column: 42
                    },
                    end: {
                        line: 173,
                        column: 64
                    }
                }],
                line: 173
            }
        },
        s: {
            '0': 0,
            '1': 0,
            '2': 0,
            '3': 0,
            '4': 0,
            '5': 0,
            '6': 0,
            '7': 0,
            '8': 0,
            '9': 0,
            '10': 0,
            '11': 0,
            '12': 0,
            '13': 0,
            '14': 0,
            '15': 0,
            '16': 0,
            '17': 0,
            '18': 0,
            '19': 0,
            '20': 0,
            '21': 0,
            '22': 0,
            '23': 0,
            '24': 0,
            '25': 0,
            '26': 0,
            '27': 0,
            '28': 0,
            '29': 0,
            '30': 0,
            '31': 0,
            '32': 0,
            '33': 0,
            '34': 0,
            '35': 0,
            '36': 0,
            '37': 0,
            '38': 0,
            '39': 0,
            '40': 0,
            '41': 0,
            '42': 0,
            '43': 0,
            '44': 0,
            '45': 0,
            '46': 0,
            '47': 0,
            '48': 0,
            '49': 0,
            '50': 0,
            '51': 0,
            '52': 0
        },
        f: {
            '0': 0,
            '1': 0,
            '2': 0,
            '3': 0,
            '4': 0,
            '5': 0,
            '6': 0,
            '7': 0,
            '8': 0,
            '9': 0,
            '10': 0,
            '11': 0,
            '12': 0,
            '13': 0,
            '14': 0,
            '15': 0,
            '16': 0,
            '17': 0,
            '18': 0,
            '19': 0,
            '20': 0
        },
        b: {
            '0': [0, 0],
            '1': [0, 0],
            '2': [0, 0],
            '3': [0, 0],
            '4': [0, 0]
        },
        _coverageSchema: '332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'
    },
        coverage = global[gcv] || (global[gcv] = {});

    if (coverage[path] && coverage[path].hash === hash) {
        return coverage[path];
    }

    coverageData.hash = hash;
    return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.deriveUtxos = deriveUtxos;

var _utils = require('../utils');

var _bitcoinjsLibZcash = require('bitcoinjs-lib-zcash');

// what is hapenning here:
// I have a state with old utxo set
// and some new transactions
// and the only thing that can happen is that new utxos arrive
// from the new transactions, or the old utxos are spent
// The way this is done, no new utxos are added "back"
// from the old transactions.
// This is to save time - we do not need to go through old
// transactions, just through the new ones
//
// Note that this on itself could cause a problem
// If there is outgoing transaction in a mempool in the old state
// that is later removed,
// old utxos need to be added;
// I find such old utxos in index.js in findDeleted
// and later pass them here
function deriveUtxos(newInfo, oldInfo, addressToPath, joined) {
    cov_itzd237m5.f[0]++;

    // First do preparations
    // Make set of all my transaction IDs, old and new
    var allTransactionHashes = (cov_itzd237m5.s[0]++, deriveAllTransactionHashes(newInfo.main.newTransactions, newInfo.change.newTransactions, oldInfo.transactions));

    // Then, make set of spent outputs
    // (tx + ":" + id)
    var spentOutputs = (cov_itzd237m5.s[1]++, deriveSpentOutputs(allTransactionHashes, newInfo.main.newTransactions, newInfo.change.newTransactions, oldInfo.transactions));

    // actual logic
    var utxos = (cov_itzd237m5.s[2]++, _deriveUtxos(oldInfo.utxos, joined, addressToPath, spentOutputs));

    cov_itzd237m5.s[3]++;
    return utxos;
}

function deriveAllTransactionHashes(main, change, old) {
    cov_itzd237m5.f[1]++;

    var res = (cov_itzd237m5.s[4]++, new Set());

    cov_itzd237m5.s[5]++;
    Object.keys(main).forEach(function (id) {
        cov_itzd237m5.f[2]++;
        cov_itzd237m5.s[6]++;

        res.add(id);
    });
    cov_itzd237m5.s[7]++;
    Object.keys(change).forEach(function (id) {
        cov_itzd237m5.f[3]++;
        cov_itzd237m5.s[8]++;

        res.add(id);
    });
    cov_itzd237m5.s[9]++;
    old.forEach(function (t) {
        cov_itzd237m5.f[4]++;
        cov_itzd237m5.s[10]++;

        res.add(t.hash);
    });

    cov_itzd237m5.s[11]++;
    return res;
}

function deriveSpentOutputs(allTransactionHashes, main, change, old) {
    cov_itzd237m5.f[5]++;

    var res = (cov_itzd237m5.s[12]++, new Set());

    // saving only mine spent outputs
    // (to save some time)
    function canTxBeMine(id) {
        cov_itzd237m5.f[6]++;
        cov_itzd237m5.s[13]++;

        return allTransactionHashes.has(id);
    }

    function saveNew(ts) {
        cov_itzd237m5.f[7]++;
        cov_itzd237m5.s[14]++;

        (0, _utils.objectValues)(ts).forEach(function (tx) {
            cov_itzd237m5.f[8]++;
            cov_itzd237m5.s[15]++;

            tx.tx.ins.forEach(function (inp) {
                cov_itzd237m5.f[9]++;

                var i = (cov_itzd237m5.s[16]++, inp.index);
                var id = (cov_itzd237m5.s[17]++, (0, _utils.getInputId)(inp));
                cov_itzd237m5.s[18]++;
                if (canTxBeMine(id)) {
                    cov_itzd237m5.b[0][0]++;
                    cov_itzd237m5.s[19]++;

                    res.add(id + ':' + i);
                } else {
                    cov_itzd237m5.b[0][1]++;
                }
            });
        });
    }

    cov_itzd237m5.s[20]++;
    old.forEach(function (t) {
        cov_itzd237m5.f[10]++;
        cov_itzd237m5.s[21]++;

        t.inputs.forEach(function (_ref) {
            var id = _ref.id,
                index = _ref.index;
            cov_itzd237m5.f[11]++;
            cov_itzd237m5.s[22]++;

            if (canTxBeMine(id)) {
                cov_itzd237m5.b[1][0]++;
                cov_itzd237m5.s[23]++;

                res.add(id + ':' + index);
            } else {
                cov_itzd237m5.b[1][1]++;
            }
        });
    });

    cov_itzd237m5.s[24]++;
    saveNew(main);
    cov_itzd237m5.s[25]++;
    saveNew(change);

    cov_itzd237m5.s[26]++;
    return res;
}

function _deriveUtxos(currentUtxos, newTransactions, addressToPath, spentOutputs) {
    cov_itzd237m5.f[12]++;

    var res = (cov_itzd237m5.s[27]++, {});

    cov_itzd237m5.s[28]++;
    var isOwnAddress = function isOwnAddress(address) {
        cov_itzd237m5.f[13]++;
        cov_itzd237m5.s[29]++;

        return (cov_itzd237m5.b[2][0]++, address != null) && (cov_itzd237m5.b[2][1]++, addressToPath[address] != null);
    };

    cov_itzd237m5.s[30]++;
    var isCoinbase = function isCoinbase(tx) {
        cov_itzd237m5.f[14]++;
        cov_itzd237m5.s[31]++;

        return tx.ins.some(function (i) {
            cov_itzd237m5.f[15]++;
            cov_itzd237m5.s[32]++;
            return _bitcoinjsLibZcash.Transaction.isCoinbaseHash(i.hash);
        });
    };

    // first, delete spent utxos from current batch from staying
    var filteredUtxos = (cov_itzd237m5.s[33]++, currentUtxos.filter(function (utxo) {
        cov_itzd237m5.f[16]++;

        var ix = (cov_itzd237m5.s[34]++, utxo.transactionHash + ':' + utxo.index);
        cov_itzd237m5.s[35]++;
        return !spentOutputs.has(ix);
    }));

    // second, add them to hash, so if there is new and confirmed utxo,
    // it will overwrite existing utxo
    cov_itzd237m5.s[36]++;
    filteredUtxos.forEach(function (utxo) {
        cov_itzd237m5.f[17]++;

        var ix = (cov_itzd237m5.s[37]++, utxo.transactionHash + ':' + utxo.index);
        cov_itzd237m5.s[38]++;
        res[ix] = utxo;
    });

    // third, find utxos in new txs and maybe overwrite existing
    var newTxs = (cov_itzd237m5.s[39]++, (0, _utils.objectValues)(newTransactions));
    cov_itzd237m5.s[40]++;
    newTxs.forEach(function (_ref2) {
        var hash = _ref2.hash,
            tx = _ref2.tx,
            height = _ref2.height,
            outputAddresses = _ref2.outputAddresses,
            inputAddresses = _ref2.inputAddresses,
            vsize = _ref2.vsize;
        cov_itzd237m5.f[18]++;

        var coinbase = (cov_itzd237m5.s[41]++, isCoinbase(tx));
        var own = (cov_itzd237m5.s[42]++, inputAddresses.some(function (address) {
            cov_itzd237m5.f[19]++;
            cov_itzd237m5.s[43]++;
            return isOwnAddress(address);
        }));

        cov_itzd237m5.s[44]++;
        tx.outs.forEach(function (o, index) {
            cov_itzd237m5.f[20]++;

            var ix = (cov_itzd237m5.s[45]++, hash + ':' + index);
            var address = (cov_itzd237m5.s[46]++, outputAddresses[index]);
            cov_itzd237m5.s[47]++;
            if ((cov_itzd237m5.b[4][0]++, spentOutputs.has(ix)) || (cov_itzd237m5.b[4][1]++, !isOwnAddress(address))) {
                cov_itzd237m5.b[3][0]++;
                cov_itzd237m5.s[48]++;

                return;
            } else {
                cov_itzd237m5.b[3][1]++;
            }

            var addressPath = (cov_itzd237m5.s[49]++, addressToPath[address]);
            var resIx = (cov_itzd237m5.s[50]++, {
                index: index,
                value: o.value,
                transactionHash: hash,
                height: height,
                coinbase: coinbase,
                addressPath: addressPath,
                vsize: vsize,
                tsize: tx.byteLength(),
                own: own
            });
            cov_itzd237m5.s[51]++;
            res[ix] = resIx;
        });
    });

    cov_itzd237m5.s[52]++;
    return (0, _utils.objectValues)(res);
}